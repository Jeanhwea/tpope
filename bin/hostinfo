#!/bin/sh
# $Id$
# -*- sh -*- vim: ft=sh sw=4 sts=4

# This script handles everything to do with hostnames, particularly
# colourizing them.

hostinfo=`basename $0`
PATH="/bin:/usr/bin:/usr/local/bin"
hosts="maggie bart clancy abe left homer right fry carl lisa marge barney mona ralph patty sarah snowball otto lenny"
menuhosts="maggie bart marge lisa homer abe mona - snowball - clancy sarah ralph"

gethost() {
    case "$1" in
    [Aa]|maggie*) echo maggie ;;
    [Bb]|bart*) echo bart ;;
    [Cc]|clancy*) echo clancy ;;
    [Ee]|abe*) echo abe ;;
    [Ff]|left*) echo left ;;
    [Hh]|homer*) echo homer ;;
    [Ii]|right*) echo right ;;
    [Jj]|fry*) echo fry ;;
    [Kk]|carl*) echo carl ;;
    [Ll]|lisa*) echo lisa ;;
    [Mm]|marge*) echo marge ;;
    [Nn]|barney*) echo barney ;;
    [Oo]|mona*) echo mona ;;
    [Pp]|ralph*) echo ralph ;;
    [Qq]|patty*) echo patty ;;
    [Rr]|sarah*) echo sarah ;;
    [Ss]|snowball*) echo snowball ;;
    [Tt]|otto*) echo otto ;;
    [Yy]|lenny*) echo lenny ;;
    ?) echo localhost ;;
    *) echo "$1" ;;
esac
}

maggie()   { hterm="01;36"; hscrn="+b C"; hrgb="#7FFFFF"; hltr=A; hdom=simpson;}
bart()     { hterm="01;31"; hscrn="+b R"; hrgb="#FFA1A1"; hltr=B; hdom=simpson;}
marge()    { hterm="01;32"; hscrn="+b G"; hrgb="#A2FFA1"; hltr=M; hdom=simpson;}
lisa()     { hterm="00;31"; hscrn="   r"; hrgb="#D57F7F"; hltr=L; hdom=simpson;}
homer()    { hterm="00;33"; hscrn="   y"; hrgb="#D5AA7F"; hltr=H; hdom=simpson;}
abe()      { hterm="00;36"; hscrn="   c"; hrgb="#7FD4D4"; hltr=E; hdom=simpson;}
mona()     { hterm="00;35"; hscrn="   m"; hrgb="#D57FD4"; hltr=O; hdom=simpson;}
snowball() { hterm="01;30"; hscrn="+b K"; hrgb="#BCBBBB"; hltr=S; hdom=simpson;
		test "$TERM" = dtterm && hscrn=d && hterm="00;37" || /bin/true;}
clancy()   { hterm="00;34"; hscrn="   b"; hrgb="#7F7FD4"; hltr=C; hdom=simpson;}
sarah()    { hterm="01;35"; hscrn="+b m"; hrgb="#FF7FFF"; hltr=R; hdom=simpson;}
ralph()    { hterm="00;32"; hscrn="   g"; hrgb="#7FD47F"; hltr=P; hdom=simpson;}

lenny()    { hterm="01;34"; hscrn="+b B"; hrgb="#A2A2FF"; hltr=Y; hdom=simpson;}
carl()     { hterm="01;34"; hscrn="+b B"; hrgb="#A2A2FF"; hltr=K; hdom=simpson;}
patty()    { hterm="01;35"; hscrn="+b M"; hrgb="#FF7FFF"; hltr=Q; hdom=simpson;}
barney()   { hterm="01;33"; hscrn="+b Y"; hrgb="#F7F67F"; hltr=N; hdom=simpson;}
otto()     { hterm="01;35"; hscrn="+b Y"; hrgb="#FF7FFF"; hltr=T; hdom=wiggum; }
fry()      { hterm="01;33"; hscrn="+b Y"; hrgb="#F7F67F"; hltr=J; hdom=wiggum; }
left()     { hterm="01;33"; hscrn="+b Y"; hrgb="#FFFF7F"; hltr=F; hdom=springfield; }
right()    { hterm="00;32"; hscrn="   g"; hrgb="#7FD47F"; hltr=I; hdom=springfield;}
unknown()  { hterm="01;37"; hscrn="+b W"; hrgb="#FFFFFF"; hltr= ; hdom=;}
getinfo() {
    $1 2>/dev/null || unknown
}

suffix() { 
    domains="`egrep '^search|^domain' /etc/resolv.conf 2>/dev/null`"
    if /sbin/ifconfig -a|grep ':172\.' >/dev/null 2>&1; then
	getinfo "$1"
	case "$domains" in *$hdom*) suffix='' ;; *) suffix=".$hdom" ;; esac
    elif /sbin/ifconfig -a|grep ':192\.168\.' >/dev/null 2>&1 && [ -S "$SSH_AUTH_SOCK" -a "$1" != localhost ]; then
	suffix=".iling"
    elif /sbin/ifconfig -a|grep ':10\.[014]' >/dev/null 2>&1 && [ -S "$SSH_AUTH_SOCK" -a "$1" != localhost ]; then
	suffix=".iling"
#    elif [ -x /usr/local/bin/connect ]; then
#	suffix=".proxy"
    else
	getinfo "$1"
	case "$domains" in *$hdom*) suffix='' ;; *) suffix=".$hdom" ;; esac
    fi
    echo $suffix
}

case "$hostinfo" in
tpope) return ;;
ruptime|rwho) exec "$HOME/bin/hostinfo" --"$hostinfo" "$@" ;;
hostinfo)
    : ${host:=`hostname`}
    case "$1" in
    -c|--host-color) eval `gethost ${2:-$host}` 2>/dev/null || unknown; echo $hterm; exit 0 ;;
    -l|--letter) eval `gethost ${2:-$host}` 2>/dev/null || unknown; echo $hltr; exit 0 ;;
    -h|--hostname) echo `gethost ${2:-$host}`; exit 0 ;;
    -s|--screen-code) eval `gethost ${2:-$host}` 2>/dev/null || unknown; echo $hscrn; exit 0 ;;
    -r|--rgb) eval `gethost ${2:-$host}` 2>/dev/null || unknown; echo $hrgb; exit 0 ;;
    -S|--ssh)
	case "$2" in
	    *.*) host="$2";;
	    *) host=`gethost ${2:-$host}` ;;
	esac
	shift; shift
	exec ssh "$host`suffix $host`" "$@" ;;
    -b|--batch-ssh)
	case "$2" in
	    *.*|-*) host="$2";;
	    *) host=`gethost ${2:-$host}` ;;
	esac
	shift; shift
	exec ssh -axqoBatchmode=yes "$host`suffix $host`" "$@" ;;
    -H)
	rm -f "$HOME"/bin/[A-Z]
	for ltr in A B C D E F G H I J K L M N O P Q R S T U V W X Y Z; do
	    ln -s hostinfo "$HOME/bin/$ltr"
	done
	exit 0
	;;
    --fvwm-styles)
	for host in $hosts; do $host 2>/dev/null || unknown;
	    [ "$host" != - ] && echo \
	    "Style *@$host* ForeColor $hrgb, HilightFore $hrgb, Icon $host.xpm"
	done
	exit 0
	;;
    --fvwm-menus)
cat<<EOF
DestroyMenu MenuFvwmScreens
DestroyMenu MenuFvwmLogins
AddToMenu MenuFvwmScreens^Green^ "Screen*norm/terminal-special.xpm*" Title
AddToMenu MenuFvwmLogins^Red^     "Login*norm/terminal-remote.xpm*"  Title
AddToMenu MenuFvwmScreens "& localhost%\$[HOST].xpm%"    FuncScreenXterm
AddToMenu MenuFvwmLogins  "& localhost%\$[HOST].xpm%"    FuncXterm
AddToMenu MenuFvwmScreens "" Nop
AddToMenu MenuFvwmLogins  "" Nop
ChangeMenuStyle Screens MenuFvwmScreens
ChangeMenuStyle Logins  MenuFvwmLogins
EOF
	for host in ${menuhosts:-$hosts}; do $host 2>/dev/null || unknown;
	    hltr=`echo $hltr|tr 'A-Z' 'a-z'`
	    if [ "$host" != - ]; then
	    case $host in *$hltr*) hmenu=`echo "$host"|sed -e "s/$hltr/\&$hltr/"` ;; *) hmenu="$host(&$hltr)" ;; esac
		echo "AddToMenu MenuFvwmScreens $hmenu%$host.xpm% FuncScreenSshXterm $host"
		echo "AddToMenu MenuFvwmLogins $hmenu%$host.xpm% FuncSshXterm $host"
	    else
		echo 'AddToMenu MenuFvwmScreens "" Nop'
		echo 'AddToMenu MenuFvwmLogins  "" Nop'
	    fi
	done
	exit 0
	;;
    --fvwm-keys)
	for host in $hosts; do $host 2>/dev/null || unknown
	    [ "$host" != - ] &&
	    echo "Key $hltr A CM  FuncScreenSshXterm $host" &&
	    echo "Key $hltr A CMS FuncSshXterm $host"
	done
	exit 0
	;;
    -u|-w|--ruptime|--rwho)
    PATH=/usr/local/bin:/usr/bin:/bin:/usr/ucb
    command="$1"; shift
    [ "$command" = -w -o "$command" = "--rwho"    ] && command=rwho
    [ "$command" = -u -o "$command" = "--ruptime" ] && command=ruptime
    if [ "$1" = "-p" ]; then
	RUPTIME=cat
	shift
    elif [ -x "`which $command 2>/dev/null`" -a "`hostname`" != grex.cyberspace.org ]; then
	RUPTIME="$command"
    else
	RUPTIME="finger $command$1@sexygeek.org"
	[ -n "$1" ] && shift
    fi
    AWK='{print $1" "$0}'
    [ "$command" = "rwho" -o "$command" = "-w" ] && AWK='BEGIN {FS="[ :][ :]*" } {print $2" "$0}'
    [ -t 1 ] && TERMINAL=1
    if [ "$TERMINAL" ]; then
	$RUPTIME "$@"|grep -v '^\[sexygeek\.org\]'|awk "$AWK"|while read host line; do
	    "$host" 2>/dev/null || hterm="01;37"
	    echo "$line"|sed -e 's/\<'$host'\>\(:\{0,1\}\)/\['$hterm'm'$host'\[01;30m\1\[00m/'
	done|sed -e 's/ up/ \[01;33mup\[00m/' -e 's/ down/ \[01;34mdown\[00m/' -e 's/\<tpope\>/\[01;33mtpope\[00m/g' -e 's/\<root\>/\[01;37mroot\[00m/g'
    else
	$RUPTIME "$@"|grep -v '^\[sexygeek\.org\]'
    fi
    exit 0
	    ;;
	    -*) echo "Usage: [-chls] [hostname]" >&2; exit 1 ;;
	    *) echo `gethost ${1:-$host}`; exit 0 ;;
	esac
	exit 2
	;;
    ?)	[ -n "$STY" ] && SCREEN="screen -ln"
	exec $SCREEN ssh `gethost $hostinfo` "$@" ;;
    batch-ssh)
	case "$2" in
	    *.*|-*) host="$2";;
	    *) host=`gethost ${2:-$host}` ;;
	esac
	shift; shift
	exec ssh -axqoBatchmode=yes "$host`suffix $host`" "$@" ;;

	*) echo WARNING ;;
esac
