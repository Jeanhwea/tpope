#!/bin/bash
# Author: Tim Pope
# -*- sh -*- vim: ft=sh sw=4 sts=4

# A seldom used script to rapidly distribute a file to a large number of
# hosts.  The idea was that if, say, I witnessed a crime, I could distribute
# evidence of it quickly as possible, so that killing me wouldn't be an
# effective way of destroying it.  As you might expect, I've yet to have a
# real use for it.

give_to_host() {
    local host defer="" loc=""
    [ "$1" = "-d" ] && skip="$2" && shift 2
    [ "$1" = "-l" ] && loc="$2" && shift 2
    host=$1; shift
    [ "$host" = "`hostname`" -o "$host" = "$skiphost" ] && return 1
    echo -n "$host: "
    if ! ping -c 1 "$host" >/dev/null 2>/dev/null; then
	echo "not alive; skipping."
	return 2
    elif [ "$skip" ]; then
	echo 'deferring...'
	if ssh -oStrictHostKeyChecking=no "$host" "cd $loc; qdist -s $skip" < $tarball 2>/dev/null; then
	#if scp -oStrictHostKeyChecking=no "$@" "$host$loc" >/dev/null; then
	    echo "done."
	    return 0
	else
	    echo "failed!"
	    return 3
	fi
    else
	if ssh -oStrictHostKeyChecking=no "$host" "cd $loc; tar xf -" < $tarball 2>/dev/null; then
	#if scp -oStrictHostKeyChecking=no "$@" "$host$loc" >/dev/null; then
	    echo 'done.'
	    return 0
	else
	    echo 'failed!'
	    return 3
	fi
    fi
}

if [ "$1" = "-s" ]; then
    skiphost=$2
    shift 2
fi

if [ "`hostname`" = grex.cyberspace.org ]; then
    echo "Sorry."
    exit 1
fi

tarball=/tmp/qdist.$$.tar

if [ -z "$*" ]; then
    cat > "$tarball"
    tar xf "$tarball"
else
    tar cf "$tarball" "$@"
fi

if [ "`hostname`" = chief ]; then
    give_to_host -d patman.homeip.net sexygeek.org
elif [ "`hostname`" != maggie ]; then
    if ! give_to_host -d `hostname` sexygeek.org; then
	give_to_host patman.homeip.net || give_to_host chief
	[ "`ls -l $tarball|awk '{print $5}'`" -le 204800 ] && \
	    give_to_host grex.cyberspace.org
    fi
else # maggie

    for host in bart lisa marge homer abe; do
	give_to_host "$host"
    done
    give_to_host patman.homeip.net || give_to_host chief
    if [ "`ls -l $tarball|awk '{print $5}'`" -le 204800 ]; then
	give_to_host grex.cyberspace.org
	give_to_host -l /mnt/cf/ snowball
    fi
fi

[ -d /mnt/usb ] && tar xC /mnt/usb -f $tarball

rm $tarball
