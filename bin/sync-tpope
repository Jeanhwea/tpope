#!/bin/sh
# $Id$
# -*- sh -*- vim:set ft=sh sw=4 sts=4:

# Keeps my configuration files in sync.  Also used to create a tarball of
# them, and commit them to Git.

# Whoops.  This script wasn't meant to be called as root.  Maybe this is what
# I meant.
[ "$EUID" = 0 ] && exec /usr/local/sbin/sync-boxen "$@"

FILES="\
 .zshenv .zshrc .zlogin .zlogout .zsh/functions/* .shrc .cshrc .login .logout \
 .profile .bashrc .bash_profile .screenrc .terminfo/? .dir_colors .irbrc \
 .vimrc .vim/[^b][^p]* .muttrc .urlview .mailcap .gnupg/gpg.conf \
 .cvsignore .ssh/config .ssh/authorized_keys .ssh/authorized_keys2 \
 .xsession .Xresources .Eterm/themes .gtkrc .gtkrc-2.0 .netscape/user.js \
 .pixmaps/mini .fvwm/.fvwm2rc .fvwm/FvwmScript-* .fvwm/.fvwm-menu-headlines \
 bin/x-terminal-emulator bin/sensible-browser bin/tpope bin/hostinfo \
 bin/sync-tpope bin/media bin/installer .ruby/lib/tpope.rb .gitconfig \
 "
LOCAL_FILES="\
 .gnupg/pubring.gpg .netscape/userContent.css .vim/bundle/home/* \
 .pork/porkrc .pork/scract.pl .kde/share/apps/konsole .qt"

RSYNC_RSH="ssh -ax"
[ -t 0 ] || RSYNC_RSH="ssh -axqoBatchMode=yes -oStrictHostKeyChecking=no -oSetupTimeOut=20"
RSYNC="rsync -urlptRC --exclude='.*.sw?' --exclude='.*.lock' --exclude='*.local'"
export RSYNC_RSH

[ -z "$TPOPE_GET" ] || return
NAME=`basename "$0"`

output_progress() {
    echo -n "$1"
}

output_newline() {
    echo
}

tar_out() {
    ( cd && tar cf - -X .cvsignore --exclude='*~' $FILES "$@" )
}

while [ "$#" -gt 0 ]; do
    case "$1" in
	-t)    trusted=1;;
	-T|+t) trusted= ;;
	-g)    loc=1    ;;
	-G|+g) loc=     ;;
	-s) simpson=1 ;;
	-A) tarpipe=1 tgzpipe= ;;
	-Z) tgzpipe=1 tarpipe= ;;
	-a) tarball=cat; shift; tarfile="${1:-'tpope.tar'}" ;;
	-z) tarball="gzip -c"; shift; tarfile="${1:-'tpope.tar.gz'}" ;;
	-j) tarball="bzip2 -zc"; shift; tarfile="${1:-'tpope.tar.bz2'}" ;;
	-c) git="commit"; shift; break ;;
	-d) git="diff"; shift; break ;;
	-w) web=1; shift; wtarfile="${1:-"$HOME/tpope.tar.gz"}"; break ;;
	-W) web=2; shift; wtarfile="${1:-"$HOME/tpope.tar.gz"}"; break ;;
	*)
	ALL_HOSTS="$1 $ALL_HOSTS"
	[ "$trusted" ] && MY_HOSTS="$1 $MY_HOSTS"
	[ "$loc" ]    && LOCAL_HOSTS="$1 $LOCAL_HOSTS"
	;;
    esac
    shift
done

if [ "$tarball" -a "$simpson$ALL_HOSTS" ]; then
    echo "Warning: hosts ignored." >&2
fi

[ -n "$ALL_HOSTS" ] || simpson=1
if [ -n "$simpson" ]; then
	MY_HOSTS="$MY_HOSTS gideon lucas todd matthew"
	ALL_HOSTS="$ALL_HOSTS roxy gideon lucas todd matthew"
	LOCAL_HOSTS="$LOCAL_HOSTS gideon lucas todd matthew"
fi

if [ -n "$git" ]; then
    umask 022
    mkdir /tmp/tpope-$$
    cd /tmp/tpope-$$
    git clone roxy:/var/cache/git/tpope.git >/dev/null || exit 1
    cd tpope
    tar_out | tar xf -
    if [ "commit" = "$git" ]; then
        git status > /dev/null
        git commit "$@" && git push
    else
        git $git "$@"
    fi
    cd
    rm -rf /tmp/tpope-$$
    exit 0
fi

if [ -n "$web" ]; then
    webget="curl -m8 -s -o"
    [ ! -x "`which wget 2>/dev/null`" ] || webget="wget -t1 -T8 -qO"
    rm -f "$wtarfile"
    if $webget "$wtarfile" http://www.tpope.us/tpope.tar.gz >/dev/null 2>&1; then
	# cygwin environments make it impossible to overwrite an open file, so
	# so we'll use this hack instead
	exec sh -c "gzip -dc \"$wtarfile\"|tar -xf - -C \"$HOME\"; [ \"$web\" != 2 ] || rm \"$wtarfile\""
    else
	echo Download failed >&2
	[ "$web" = 2 ] && rm "$wtarfile"
	exit 1
    fi
fi

if [ -n "$tarball" ]; then
    if [ "x-" = "x$tarfile" ]; then
        tar_out ${loc:+$LOCAL_FILES} | $tarball
    else
        tar_out ${loc:+$LOCAL_FILES} | $tarball > "$tarfile"
    fi
    exit
fi

cd "$HOME"

hostname="`hostname|sed -e 's/\..*//'`"
hostname_f="`hostname -f 2>/dev/null || hostname`"
if [ "$tarpipe" ]; then

    output_progress "Uploading base:   "
    for host in $ALL_HOSTS; do
	[ "$host" != "$hostname" -a "$host" != "$hostname_f" ] && \
	tar_out | $RSYNC_RSH $host 'tar xpf -' 2>/dev/null && \
	    output_progress " $host"
    done
    output_newline

    [ "$LOCAL_HOSTS" ] && output_progress "Uploading extra:  " && \
    for host in $LOCAL_HOSTS; do
	[ "$host" != "$hostname" -a "$host" != "$hostname_f" ] && \
	tar cf - -X .cvsignore --exclude='*~' $LOCAL_FILES|\
	    $RSYNC_RSH $host 'tar xpf -' 2>/dev/null && \
	    output_progress " $host"
    done && \
    output_newline

    exit 0
fi

if [ "$tgzpipe" ]; then

    output_progress "Uploading base:   "
    for host in $ALL_HOSTS; do
	[ "$host" != "$hostname" -a "$host" != "$hostname_f" ] && \
	tar cf - -X .cvsignore --exclude='*~' \
	    $FILES|gzip -c|$RSYNC_RSH $host 'gzip -cd|tar xpf -' 2>/dev/null && \
	    output_progress " $host"
    done
    output_newline

    [ "$LOCAL_HOSTS" ] && output_progress "Uploading extra:  " && \
    for host in $LOCAL_HOSTS; do
	[ "$host" != "$hostname" -a "$host" != "$hostname_f" ] && \
	tar cf - -X .cvsignore --exclude='*~' $LOCAL_FILES |\
	    gzip -c|$RSYNC_RSH $host 'gzip -cd|tar xpf -' 2>/dev/null && \
	    output_progress " $host"
    done && \
    output_newline

    exit 0
fi

if [ -f "$HOME/.LCK..$NAME" ]; then
    if [ -d "/proc/`cat $HOME/.LCK..$NAME`" ]; then
	echo "Locked.  Exiting." >&2
	exit 1
    else
	echo "Stale lock file found.  Removing." >&2
	rm -f $HOME/.LCK..$NAME
    fi
fi

trap 'rm -f "$HOME/.LCK..$NAME"' EXIT
echo $$ > $HOME/.LCK..$NAME

if [ "$MY_HOSTS" ]; then
output_progress "Downloading base: "
for host in $MY_HOSTS; do
    if [ "$host" != "$hostname" -a "$host" != "$hostname_f" ]; then
	$RSYNC_RSH $host $RSYNC "$FILES" "$hostname:" 2>/dev/null &&
	output_progress " $host"
    fi
done
output_newline
fi

output_progress "Uploading base:   "
for host in $ALL_HOSTS; do
    if [ "$host" != "$hostname" -a "$host" != "$hostname_f" ]; then
	$RSYNC --delete $FILES $host: 2>/dev/null &&
	output_progress " $host"
    fi
done
output_newline

if [ "$LOCAL_HOSTS" ]; then
output_progress "Downloading extra:"
for host in $LOCAL_HOSTS; do
    if [ "$host" != "$hostname" -a "$host" != "$hostname_f" ]; then
	$RSYNC_RSH $host $RSYNC "$LOCAL_FILES" "$hostname:" 2>/dev/null &&
	output_progress " $host"
    fi
done
output_newline

output_progress "Uploading extra:  "
for host in $LOCAL_HOSTS; do
    if [ "$host" != "$hostname" ]; then
	$RSYNC --delete $LOCAL_FILES $host: 2>/dev/null &&
	output_progress " $host"
    fi
done
output_newline
fi

rm -f "$HOME/.LCK..$NAME"
